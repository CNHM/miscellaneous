-- HMUI - Roblox 高级移动端 UI 库
-- 作者: 黄某脚本中心
-- 支持: 圆角、动画、拖动、通知、移动端触摸
-- 调用通知库: NotificationLib.Show({...})

local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")

local NotificationLib = loadstring(game:HttpGet("https://raw.githubusercontent.com/CNHM/miscellaneous/main/Notifying"))()

local UI = {}

UI.Theme = {
	Background = Color3.fromRGB(24, 24, 28),
	Panel = Color3.fromRGB(32, 32, 36),
	Accent = Color3.fromRGB(70, 145, 255),
	Text = Color3.fromRGB(240, 240, 240),
	Muted = Color3.fromRGB(150, 150, 150)
}

local function roundCorner(obj, r)
	local c = Instance.new("UICorner")
	c.CornerRadius = r or UDim.new(0, 8)
	c.Parent = obj
end

local function makeLabel(parent, text, size, pos, align)
	local l = Instance.new("TextLabel")
	l.Parent = parent
	l.Size = size or UDim2.new(1, 0, 0, 30)
	l.Position = pos or UDim2.new(0, 0, 0, 0)
	l.BackgroundTransparency = 1
	l.Text = text
	l.TextColor3 = UI.Theme.Text
	l.Font = Enum.Font.GothamSemibold
	l.TextSize = 16
	l.TextXAlignment = align or Enum.TextXAlignment.Left
	return l
end

local function tween(obj, goal, time, style)
	local info = TweenInfo.new(time or 0.3, style or Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
	TweenService:Create(obj, info, goal):Play()
end

local function new(class, props)
	local obj = Instance.new(class)
	for k, v in pairs(props) do
		obj[k] = v
	end
	return obj
end

function UI:Notify(opt)
	NotificationLib.Show({
		title = opt.title or "提示",
		subtitle = opt.subtitle or "",
		duration = opt.duration or 5,
		position = opt.position or "right",
		icon = opt.icon or "rbxassetid://1234567890",
		soundId = opt.soundId or "rbxassetid://18595195017"
	})
end

function UI:CreateScreenGui(name)
	local g = Instance.new("ScreenGui")
	g.Name = name or "HMUI"
	g.ResetOnSpawn = false
	g.IgnoreGuiInset = true
	g.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")
	return g
end

function UI:CreateWindow(parent, opt)
	local frame = new("Frame", {
		Parent = parent,
		Size = UDim2.new(0, 360, 0, 450),
		Position = UDim2.new(0.5, -180, 0.5, -225),
		BackgroundColor3 = UI.Theme.Background,
		Active = true,
		Draggable = true,
	})
	roundCorner(frame, UDim.new(0, 12))

	local title = makeLabel(frame, opt.Title or "窗口", UDim2.new(1, -16, 0, 40), UDim2.new(0, 8, 0, 0))
	title.Font = Enum.Font.GothamBold
	title.TextSize = 18
	title.TextColor3 = UI.Theme.Accent

	local content = new("Frame", {
		Parent = frame,
		BackgroundTransparency = 1,
		Size = UDim2.new(1, -16, 1, -56),
		Position = UDim2.new(0, 8, 0, 48)
	})

	local layout = new("UIListLayout", {
		Parent = content,
		SortOrder = Enum.SortOrder.LayoutOrder,
		Padding = UDim.new(0, 10)
	})

	return {Frame = frame, Content = content}
end

function UI:CreateButton(parent, text, callback)
	local b = new("TextButton", {
		Parent = parent,
		Size = UDim2.new(1, 0, 0, 40),
		Text = text,
		BackgroundColor3 = UI.Theme.Panel,
		TextColor3 = UI.Theme.Text,
		Font = Enum.Font.Gotham,
		TextSize = 16
	})
	roundCorner(b)
	b.MouseButton1Click:Connect(function()
		tween(b, {BackgroundColor3 = UI.Theme.Accent}, 0.1)
		task.wait(0.1)
		tween(b, {BackgroundColor3 = UI.Theme.Panel}, 0.3)
		if callback then callback() end
	end)
	return b
end

-- ✅ 修复后的 Toggle（含动画，支持触摸）
function UI:CreateToggle(parent, text, state, callback)
	local f = new("Frame", {Parent = parent, Size = UDim2.new(1,0,0,40), BackgroundTransparency = 1})
	local lbl = makeLabel(f, text or "开关", UDim2.new(0.7,0,1,0), UDim2.new(0,8,0,0))

	local toggle = new("Frame", {
		Parent = f,
		Size = UDim2.new(0,56,0,26),
		Position = UDim2.new(1,-64,0,7),
		BackgroundColor3 = UI.Theme.Panel,
		Active = true
	})
	roundCorner(toggle, UDim.new(0,13))

	local knob = new("Frame", {
		Parent = toggle,
		Size = UDim2.new(0,20,0,20),
		Position = UDim2.new(0,3,0,3),
		BackgroundColor3 = UI.Theme.Muted,
		Active = true
	})
	roundCorner(knob, UDim.new(0,10))

	local on = state and true or false

	local function computePositions()
		local padding = 4
		local knobW = knob.AbsoluteSize.X
		local toggleW = toggle.AbsoluteSize.X
		local offPos = UDim2.new(0, padding - 1, 0, 3)
		local onPos = UDim2.new(0, math.max(3, toggleW - knobW - padding), 0, 3)
		return offPos, onPos
	end

	local function setState(v, instant)
		on = v
		if toggle.AbsoluteSize.X == 0 or knob.AbsoluteSize.X == 0 then
			if on then
				knob.Position = UDim2.new(1, - (knob.Size.X.Offset + 6), 0, 3)
				toggle.BackgroundColor3 = UI.Theme.Accent
			else
				knob.Position = UDim2.new(0, 3, 0, 3)
				toggle.BackgroundColor3 = UI.Theme.Panel
			end
			return
		end

		local offPos, onPos = computePositions()
		if instant then
			knob.Position = on and onPos or offPos
			toggle.BackgroundColor3 = on and UI.Theme.Accent or UI.Theme.Panel
		else
			tween(knob, {Position = on and onPos or offPos}, 0.14)
			tween(toggle, {BackgroundColor3 = on and UI.Theme.Accent or UI.Theme.Panel}, 0.14)
		end
		if callback then pcall(callback, on) end
	end

	task.defer(function()
		task.wait(0.03)
		setState(on, true)
	end)

	toggle.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
			setState(not on, false)
		end
	end)

	toggle:GetPropertyChangedSignal("AbsoluteSize"):Connect(function()
		setState(on, true)
	end)

	return f
end

function UI:CreateSlider(parent, text, min, max, val, callback)
	local f = new("Frame", {Parent = parent, Size = UDim2.new(1,0,0,50), BackgroundTransparency = 1})
	makeLabel(f, text or "滑块", UDim2.new(1,0,0,20), nil)
	local bar = new("Frame", {
		Parent = f,
		Size = UDim2.new(1,-16,0,8),
		Position = UDim2.new(0,8,0,30),
		BackgroundColor3 = UI.Theme.Panel
	})
	roundCorner(bar, UDim.new(0,4))
	local fill = new("Frame", {
		Parent = bar,
		Size = UDim2.new((val-min)/(max-min),0,1,0),
		BackgroundColor3 = UI.Theme.Accent
	})
	roundCorner(fill, UDim.new(0,4))
	local dragging = false
	bar.InputBegan:Connect(function(i)
		if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
			dragging = true
		end
	end)
	UserInputService.InputEnded:Connect(function(i)
		if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
			dragging = false
		end
	end)
	UserInputService.InputChanged:Connect(function(i)
		if dragging and (i.UserInputType == Enum.UserInputType.MouseMovement or i.UserInputType == Enum.UserInputType.Touch) then
			local rel = (i.Position.X - bar.AbsolutePosition.X)/bar.AbsoluteSize.X
			rel = math.clamp(rel,0,1)
			fill.Size = UDim2.new(rel,0,1,0)
			local valNow = math.floor(min + (max-min)*rel)
			if callback then pcall(callback,valNow) end
		end
	end)
	return f
end

function UI:CreateTextBox(parent, text, placeholder, callback)
	local f = new("Frame",{Parent=parent,Size=UDim2.new(1,0,0,40),BackgroundTransparency=1})
	makeLabel(f,text or "文本输入",UDim2.new(1,0,0,20))
	local box = new("TextBox",{
		Parent=f,
		PlaceholderText=placeholder or "",
		Size=UDim2.new(1,-16,0,20),
		Position=UDim2.new(0,8,0,20),
		TextColor3=UI.Theme.Text,
		BackgroundColor3=UI.Theme.Panel,
		Text= "",
		Font=Enum.Font.Gotham,
		TextSize=14
	})
	roundCorner(box)
	box.FocusLost:Connect(function()
		if callback then pcall(callback,box.Text) end
	end)
	return f
end

function UI:CreateProgressBar(parent, text, progress)
	local f = new("Frame",{Parent=parent,Size=UDim2.new(1,0,0,50),BackgroundTransparency=1})
	makeLabel(f,text or "进度",UDim2.new(1,0,0,20))
	local bar = new("Frame",{
		Parent=f,Size=UDim2.new(1,-16,0,8),
		Position=UDim2.new(0,8,0,30),
		BackgroundColor3=UI.Theme.Panel
	})
	roundCorner(bar,UDim.new(0,4))
	local fill = new("Frame",{Parent=bar,Size=UDim2.new(progress or 0,0,1,0),BackgroundColor3=UI.Theme.Accent})
	roundCorner(fill,UDim.new(0,4))
	function f:SetProgress(p)
		p=math.clamp(p,0,1)
		tween(fill,{Size=UDim2.new(p,0,1,0)},0.2)
	end
	return f
end

function UI:CreateColorPicker(parent, text, callback)
	local f=new("Frame",{Parent=parent,Size=UDim2.new(1,0,0,40),BackgroundTransparency=1})
	local lbl=makeLabel(f,text or "颜色选择",UDim2.new(0.7,0,1,0),UDim2.new(0,8,0,0))
	local box=new("TextButton",{Parent=f,Size=UDim2.new(0,36,0,24),Position=UDim2.new(1,-44,0,8),BackgroundColor3=UI.Theme.Accent,Text=""})
	roundCorner(box)
	box.MouseButton1Click:Connect(function()
		local color = Color3.fromHSV(math.random(),1,1)
		tween(box,{BackgroundColor3=color},0.2)
		if callback then pcall(callback,color) end
	end)
	return f
end

return UI
