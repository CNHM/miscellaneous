-- Roblox 本地脚本通知 UI 库（添加音效支持版）
-- 将此脚本放置在 StarterPlayerScripts 或类似位置的 LocalScript 中
-- 更新：增加通知音效支持（默认ID: 18595195017）；在滑入后播放；支持自定义soundId参数；新增公共PlaySound函数（本地调用音效）

local NotificationLib = {}
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local SoundService = game:GetService("SoundService")
local UserInputService = game:GetService("UserInputService")  -- 可选，用于检测输入，但这里用于屏幕大小

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local camera = workspace.CurrentCamera

-- 如果不存在，创建 ScreenGui
local screenGui = playerGui:FindFirstChild("NotificationGui")
if not screenGui then
    screenGui = Instance.new("ScreenGui")
    screenGui.Name = "NotificationGui"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = playerGui
end

local notificationsFolder = screenGui:FindFirstChild("Notifications")
if not notificationsFolder then
    notificationsFolder = Instance.new("Folder")
    notificationsFolder.Name = "Notifications"
    notificationsFolder.Parent = screenGui
end

local activeNotifications = {}
local spacing = 10  -- 通知间距
local notificationWidth = 300
local notificationHeight = 80
local cornerRadius = UDim.new(0, 8)
local slideDuration = 0.5
local fadeDuration = 0.3
local maxScreenUsage = 0.8  -- 最大使用屏幕高度的80%
local defaultSoundId = "rbxassetid://18595195017"  -- 默认通知音效ID（从搜索获取）

-- 获取屏幕高度（可本地检测）
local function getScreenHeight()
    return camera.ViewportSize.Y
end

-- 更新所有活动通知的位置（从底部向上堆叠，添加边界检测）
local function updatePositions()
    local screenHeight = getScreenHeight()
    local maxHeight = screenHeight * maxScreenUsage
    local totalHeight = #activeNotifications * (notificationHeight + spacing) - spacing  -- 总高度
    local adjustedSpacing = spacing  -- 默认间距

    -- 如果总高度超过最大允许，压缩间距（最小1）
    if totalHeight > maxHeight then
        adjustedSpacing = math.max(1, (maxHeight - (#activeNotifications * notificationHeight)) / (#activeNotifications - 1))
    end

    for i, frame in ipairs(activeNotifications) do
        local yOffset = -notificationHeight - 20 - ((#activeNotifications - i) * (notificationHeight + adjustedSpacing))
        local targetPos = UDim2.new(frame.Position.X.Scale, frame.Position.X.Offset, 1, yOffset)
        TweenService:Create(frame, TweenInfo.new(0.2, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {Position = targetPos}):Play()
    end

    -- 可本地检测：打印或返回当前UI状态（用于调试/检测）
    print("检测UI状态: 活动通知数=" .. #activeNotifications .. ", 总高度=" .. totalHeight .. ", 屏幕高度=" .. screenHeight .. ", 调整间距=" .. adjustedSpacing)
end

-- 彩虹颜色序列，用于 UIGradient
local function createRainbowGradient()
    local colorSequence = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromHSV(0, 1, 1)),
        ColorSequenceKeypoint.new(0.17, Color3.fromHSV(0.17, 1, 1)),
        ColorSequenceKeypoint.new(0.33, Color3.fromHSV(0.33, 1, 1)),
        ColorSequenceKeypoint.new(0.5, Color3.fromHSV(0.5, 1, 1)),
        ColorSequenceKeypoint.new(0.66, Color3.fromHSV(0.66, 1, 1)),
        ColorSequenceKeypoint.new(0.83, Color3.fromHSV(0.83, 1, 1)),
        ColorSequenceKeypoint.new(1, Color3.fromHSV(1, 1, 1))
    })
    return colorSequence
end

-- 在 UIStroke 上动画彩虹流动效果（RenderStepped手动每帧更新，无中断、无变形）
local function animateRainbowStroke(gradient)
    local startTime = tick()
    local rotationSpeed = 120  -- 度/秒（3秒一圈，顺时针）
    local connection
    connection = RunService.RenderStepped:Connect(function()
        if gradient and gradient.Parent and gradient.Parent.Parent then  -- 检查存在
            local elapsed = tick() - startTime
            gradient.Rotation = (elapsed * rotationSpeed) % 360  -- 连续计算，%360无缝循环
        else
            connection:Disconnect()  -- 自动清理
        end
    end)
    -- 绑定到frame销毁
    gradient.Parent.Parent.AncestryChanged:Connect(function()
        if not gradient.Parent then
            if connection then
                connection:Disconnect()
            end
        end
    end)
end

-- 创建单个通知框架
local function createNotification(params)
    local title = params.title or "主标题"
    local subtitle = params.subtitle or "副标题"
    local duration = params.duration or 5
    local position = params.position or "right"  -- "left" 或 "right"
    local icon = params.icon  -- 字符串：rbxassetid 或 http URL
    local soundId = params.soundId or defaultSoundId  -- 支持自定义音效ID

    local isRight = position == "right"
    local startX = isRight and UDim2.new(1, 0, 1, 0) or UDim2.new(-1, 0, 1, 0)
    local targetX = isRight and UDim2.new(1, -notificationWidth - 20, 1, -notificationHeight - 20) or UDim2.new(0, 20, 1, -notificationHeight - 20)
    local exitX = isRight and UDim2.new(1, 0, 1, 0) or UDim2.new(-1, 0, 1, 0)

    -- 初始Y位置（临时底部，避免重叠）
    local startY = UDim2.new(0, 0, 1, -notificationHeight - 20)

    local frame = Instance.new("Frame")
    frame.Name = "Notification"
    frame.Size = UDim2.new(0, notificationWidth, 0, notificationHeight)
    frame.Position = UDim2.new(startX.X.Scale, startX.X.Offset, startY.Y.Scale, startY.Y.Offset)
    frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    frame.BorderSizePixel = 0
    frame.Parent = notificationsFolder

    -- 添加检测属性（可本地检测UI状态）
    frame:SetAttribute("NotificationIndex", #activeNotifications + 1)
    frame:SetAttribute("ScreenHeightDetected", getScreenHeight())

    local corner = Instance.new("UICorner")
    corner.CornerRadius = cornerRadius
    corner.Parent = frame

    -- 边框带有彩虹流动效果
    local stroke = Instance.new("UIStroke")
    stroke.Color = Color3.new(1, 1, 1)  -- 初始值，但会被渐变覆盖
    stroke.Thickness = 2
    stroke.Parent = frame

    local gradient = Instance.new("UIGradient")
    gradient.Color = createRainbowGradient()
    gradient.Rotation = 0
    gradient.Parent = stroke

    animateRainbowStroke(gradient)  -- 使用优化手动更新启动无缝旋转

    -- 通知音效
    local notificationSound = Instance.new("Sound")
    notificationSound.SoundId = soundId
    notificationSound.Volume = 0.5  -- 音量可调
    notificationSound.Parent = frame

    -- 图标
    local iconLabel = nil
    if icon then
        iconLabel = Instance.new("ImageLabel")
        iconLabel.Size = UDim2.new(0, 16, 0, 16)  -- 与主标题大小匹配的小图标
        iconLabel.Position = UDim2.new(0, 10, 0, 5)  -- 左上角图标
        iconLabel.BackgroundTransparency = 1
        iconLabel.Image = type(icon) == "number" and "rbxassetid://" .. tostring(icon) or icon
        iconLabel.Parent = frame
    end

    -- 主标题（移到左上角，宽度限制，字体大小保持14）
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(0, 240, 0, 18)  -- 宽度限制到240，避免过宽
    titleLabel.Position = iconLabel and UDim2.new(0, 30, 0, 5) or UDim2.new(0, 10, 0, 5)  -- 左上角，有图标右靠
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = title
    titleLabel.TextColor3 = Color3.new(1, 1, 1)
    titleLabel.TextScaled = false
    titleLabel.TextSize = 14  -- 保持
    titleLabel.Font = Enum.Font.SourceSansBold  -- 加粗以突出
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.TextTruncate = Enum.TextTruncate.AtEnd  -- 过长截断
    titleLabel.Parent = frame

    -- 副标题（调整到主标题下方）
    local subtitleLabel = Instance.new("TextLabel")
    subtitleLabel.Size = UDim2.new(1, -20, 0, 20)
    subtitleLabel.Position = UDim2.new(0, 10, 0, 25)  -- 下移到主标题下方
    subtitleLabel.BackgroundTransparency = 1
    subtitleLabel.Text = subtitle
    subtitleLabel.TextColor3 = Color3.new(1, 1, 1)
    subtitleLabel.TextScaled = false
    subtitleLabel.TextSize = 16
    subtitleLabel.Font = Enum.Font.SourceSansBold
    subtitleLabel.TextXAlignment = Enum.TextXAlignment.Left
    subtitleLabel.TextTruncate = Enum.TextTruncate.AtEnd
    subtitleLabel.Parent = frame

    -- 进度条（从左到右填充）
    local progressFrame = Instance.new("Frame")
    progressFrame.Size = UDim2.new(1, -20, 0, 4)
    progressFrame.Position = UDim2.new(0, 10, 1, -10)
    progressFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    progressFrame.BorderSizePixel = 0
    progressFrame.Parent = frame

    local progressCorner = Instance.new("UICorner")
    progressCorner.CornerRadius = UDim.new(0, 2)
    progressCorner.Parent = progressFrame

    local progressBar = Instance.new("Frame")
    progressBar.Size = UDim2.new(0, 0, 1, 0)  -- 从0宽度开始
    progressBar.Position = UDim2.new(0, 0, 0, 0)
    progressBar.BackgroundColor3 = Color3.fromRGB(100, 200, 100)
    progressBar.BorderSizePixel = 0
    progressBar.Parent = progressFrame

    local progressCorner2 = Instance.new("UICorner")
    progressCorner2.CornerRadius = UDim.new(0, 2)
    progressCorner2.Parent = progressBar

    -- 剩余秒数显示
    local timerLabel = Instance.new("TextLabel")
    timerLabel.Size = UDim2.new(0, 50, 0, 20)
    timerLabel.Position = UDim2.new(1, -60, 0.5, -10)  -- 右上角显示
    timerLabel.BackgroundTransparency = 1
    timerLabel.Text = tostring(duration) .. "秒"
    timerLabel.TextColor3 = Color3.new(1, 1, 1)
    timerLabel.TextScaled = true
    timerLabel.Font = Enum.Font.SourceSans
    timerLabel.TextXAlignment = Enum.TextXAlignment.Right
    timerLabel.Parent = frame

    -- 滑入动画（初始从边缘滑入，Y临时底部）
    local slideInInfo = TweenInfo.new(slideDuration, Enum.EasingStyle.Quart, Enum.EasingDirection.Out)
    local slideInTween = TweenService:Create(frame, slideInInfo, {
        Position = UDim2.new(targetX.X.Scale, targetX.X.Offset, 1, -notificationHeight - 20)  -- 先滑入临时Y
    })
    slideInTween:Play()

    -- 进度条动画（从0到1宽度，从左到右）
    local progressInfo = TweenInfo.new(duration, Enum.EasingStyle.Linear)
    local progressTween = TweenService:Create(progressBar, progressInfo, {Size = UDim2.new(1, 0, 1, 0)})  -- 到满宽度

    -- 倒计时更新（剩余秒数）
    local startTime = tick()
    local timerConnection
    timerConnection = RunService.Heartbeat:Connect(function()
        local elapsed = tick() - startTime
        local remainingTime = math.max(0, duration - elapsed)
        timerLabel.Text = math.floor(remainingTime + 0.5) .. "秒"  -- 四舍五入显示

        if remainingTime <= 0 then
            timerConnection:Disconnect()
        end
    end)

    -- 等待滑入完成，然后启动进度、播放音效并更新位置
    slideInTween.Completed:Connect(function()
        startTime = tick()  -- 重置计时器，确保从滑入后开始
        progressTween:Play()
        notificationSound:Play()  -- 播放通知音效
        -- 添加到列表并更新所有位置（堆叠）
        table.insert(activeNotifications, frame)
        updatePositions()  -- 关键：添加后立即更新堆叠（含检测）
    end)

    -- 持续时间后滑出
    progressTween.Completed:Connect(function()
        timerConnection:Disconnect()
        local slideOutInfo = TweenInfo.new(slideDuration, Enum.EasingStyle.Quart, Enum.EasingDirection.In)
        local slideOutTween = TweenService:Create(frame, slideOutInfo, {
            Position = UDim2.new(exitX.X.Scale, exitX.X.Offset, frame.Position.Y.Scale, frame.Position.Y.Offset)
        })
        slideOutTween:Play()

        slideOutTween.Completed:Connect(function()
            frame:Destroy()
            -- 从活动列表中移除并更新位置
            for i, notif in ipairs(activeNotifications) do
                if notif == frame then
                    table.remove(activeNotifications, i)
                    break
                end
            end
            updatePositions()  -- 移除后更新剩余位置（含检测）
        end)
    end)
end

-- 公共函数
function NotificationLib.Show(params)
    spawn(function()
        createNotification(params)
    end)
end

-- 新增：公共检测函数（可本地调用检测UI状态）
function NotificationLib.DetectUI()
    updatePositions()  -- 强制更新并打印检测
    return {
        activeCount = #activeNotifications,
        screenHeight = getScreenHeight(),
        totalHeight = #activeNotifications * (notificationHeight + spacing) - spacing
    }
end

-- 新增：本地调用通知音效（支持自定义ID）
function NotificationLib.PlaySound(soundId)
    local sound = Instance.new("Sound")
    sound.SoundId = soundId or defaultSoundId
    sound.Volume = 0.5
    sound.Parent = SoundService
    sound:Play()
    sound.Ended:Connect(function()
        sound:Destroy()
    end)
end

return NotificationLib
